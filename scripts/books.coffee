async = require 'async'
fs = require 'fs'
needle = require 'needle'

books = ['0988245108', '0988245116', '1416594795', '0618918248', '0446697966',
    '0307278778', '0143038338', '1569755671', '1569756775', 'B009SJZNS8',
    '0062225790', '1587314525', '1439171211', '0809059185', 'B00C2TWWUI',
    'B00EY3DN58', '1482773341', '0557709911', '1939578094', '1478716568',
    '161614727X', '0814410960', '0805243011', '1608681831', '0745953220',
    '0910309205', '1908675055', '0385527071', '0061335304', '0578003880',
    '0446697966', '161614551X', '006167012X', '1616144130', '1616141689',
    '0802778372', '0970950519', '1616145994', '1456588850', '1591025923',
    '0970950543', '1591025672', '023033895X', '0984493212', '1451675046',
    '1250008808', '1451683405', '1455523003', '1591280699', '1591027519',
    '0671203231', '1420802933', '0814797237', '1475165722', '0767926153',
    '0060859512', '0805077766',
    '1449398588', '032182010X', '1118168445', '0470124741', '1449321887',
    'B009SJZNS8', '0062225790', '1587314525', '1439171211', '0809059185',
    'B00C2TWWUI']

fetch = (asin, done) ->
    url = "http://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=#{asin}&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=bibvicom-20"
    console.log "Fetching #{asin}.png from #{url}"
    needle.get(url, {output: "#{asin}.png", follow: true}, (err, res, body) ->
        done(err)
    )

async.eachSeries books, fetch, (err) ->
    if err then console.log(err)
